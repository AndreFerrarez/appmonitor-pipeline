name: ðŸ©º Automated Diagnostics

on:
  workflow_dispatch:

jobs:
  run-diagnostics:
    name: Run Environment Diagnostics
    runs-on: ubuntu-latest
    steps:
      - name: Check for required variables and secrets
        run: |
          # Flag to track if any checks fail
          FAIL=false

          echo "### ðŸ©º RelatÃ³rio de DiagnÃ³stico do Ambiente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| VerificaÃ§Ã£o | Status | ObservaÃ§Ãµes |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY

          # Check for APP_ENV variable
          if [ -z "${{ vars.APP_ENV }}" ]; then
            echo "::error::A variÃ¡vel de repositÃ³rio APP_ENV nÃ£o estÃ¡ definida."
            echo "| `APP_ENV` | âŒ Falhou | VariÃ¡vel nÃ£o encontrada. Defina em Settings > Secrets and variables > Actions. |" >> $GITHUB_STEP_SUMMARY
            FAIL=true
          else
            echo "âœ… VariÃ¡vel APP_ENV encontrada."
            echo "| `APP_ENV` | âœ… OK | Valor: `${{ vars.APP_ENV }}` |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for API_KEY secret
          if [ -z "${{ secrets.API_KEY }}" ]; then
            echo "::error::O segredo API_KEY nÃ£o estÃ¡ definido."
            echo "| `API_KEY` | âŒ Falhou | Segredo nÃ£o encontrado. Defina em Settings > Secrets and variables > Actions. |" >> $GITHUB_STEP_SUMMARY
            FAIL=true
          else
            echo "âœ… Segredo API_KEY encontrado."
            echo "| `API_KEY` | âœ… OK | Segredo estÃ¡ presente. |" >> $GITHUB_STEP_SUMMARY
          fi

          # Fail the step if any check failed
          if [ "$FAIL" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**AÃ§Ã£o necessÃ¡ria:** Corrija os problemas acima para garantir a execuÃ§Ã£o correta dos pipelines." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi